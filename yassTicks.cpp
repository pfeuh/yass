/*
 * file : yassTicks.cpp
 * Copyright (c) pfeuh <ze.pfeuh@gmail>
 * All rights reserved.
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

#include "yassTicks.h"

const PROGMEM word YASS_TICKS_usec_durations[] =
{
     45455, // 55 bpm
     44643, // 56 bpm
     43860, // 57 bpm
     43103, // 58 bpm
     42373, // 59 bpm
     41667, // 60 bpm
     40984, // 61 bpm
     40323, // 62 bpm
     39683, // 63 bpm
     39063, // 64 bpm
     38462, // 65 bpm
     37879, // 66 bpm
     37313, // 67 bpm
     36765, // 68 bpm
     36232, // 69 bpm
     35714, // 70 bpm
     35211, // 71 bpm
     34722, // 72 bpm
     34247, // 73 bpm
     33784, // 74 bpm
     33333, // 75 bpm
     32895, // 76 bpm
     32468, // 77 bpm
     32051, // 78 bpm
     31646, // 79 bpm
     31250, // 80 bpm
     30864, // 81 bpm
     30488, // 82 bpm
     30120, // 83 bpm
     29762, // 84 bpm
     29412, // 85 bpm
     29070, // 86 bpm
     28736, // 87 bpm
     28409, // 88 bpm
     28090, // 89 bpm
     27778, // 90 bpm
     27473, // 91 bpm
     27174, // 92 bpm
     26882, // 93 bpm
     26596, // 94 bpm
     26316, // 95 bpm
     26042, // 96 bpm
     25773, // 97 bpm
     25510, // 98 bpm
     25253, // 99 bpm
     25000, // 100 bpm
     24752, // 101 bpm
     24510, // 102 bpm
     24272, // 103 bpm
     24038, // 104 bpm
     23810, // 105 bpm
     23585, // 106 bpm
     23364, // 107 bpm
     23148, // 108 bpm
     22936, // 109 bpm
     22727, // 110 bpm
     22523, // 111 bpm
     22321, // 112 bpm
     22124, // 113 bpm
     21930, // 114 bpm
     21739, // 115 bpm
     21552, // 116 bpm
     21368, // 117 bpm
     21186, // 118 bpm
     21008, // 119 bpm
     20833, // 120 bpm
     20661, // 121 bpm
     20492, // 122 bpm
     20325, // 123 bpm
     20161, // 124 bpm
     20000, // 125 bpm
     19841, // 126 bpm
     19685, // 127 bpm
     19531, // 128 bpm
     19380, // 129 bpm
     19231, // 130 bpm
     19084, // 131 bpm
     18939, // 132 bpm
     18797, // 133 bpm
     18657, // 134 bpm
     18519, // 135 bpm
     18382, // 136 bpm
     18248, // 137 bpm
     18116, // 138 bpm
     17986, // 139 bpm
     17857, // 140 bpm
     17730, // 141 bpm
     17606, // 142 bpm
     17483, // 143 bpm
     17361, // 144 bpm
     17241, // 145 bpm
     17123, // 146 bpm
     17007, // 147 bpm
     16892, // 148 bpm
     16779, // 149 bpm
     16667, // 150 bpm
     16556, // 151 bpm
     16447, // 152 bpm
     16340, // 153 bpm
     16234, // 154 bpm
     16129, // 155 bpm
     16026, // 156 bpm
     15924, // 157 bpm
     15823, // 158 bpm
     15723, // 159 bpm
     15625, // 160 bpm
     15528, // 161 bpm
     15432, // 162 bpm
     15337, // 163 bpm
     15244, // 164 bpm
     15152, // 165 bpm
     15060, // 166 bpm
     14970, // 167 bpm
     14881, // 168 bpm
     14793, // 169 bpm
     14706, // 170 bpm
     14620, // 171 bpm
     14535, // 172 bpm
     14451, // 173 bpm
     14368, // 174 bpm
     14286, // 175 bpm
     14205, // 176 bpm
     14124, // 177 bpm
     14045, // 178 bpm
     13966, // 179 bpm
     13889, // 180 bpm
     13812, // 181 bpm
     13736, // 182 bpm
     13661, // 183 bpm
     13587, // 184 bpm
     13514, // 185 bpm
     13441, // 186 bpm
     13369, // 187 bpm
     13298, // 188 bpm
     13228, // 189 bpm
     13158, // 190 bpm
     13089, // 191 bpm
     13021, // 192 bpm
     12953, // 193 bpm
     12887, // 194 bpm
     12821, // 195 bpm
     12755, // 196 bpm
     12690, // 197 bpm
     12626, // 198 bpm
     12563, // 199 bpm
     12500, // 200 bpm
     12438, // 201 bpm
     12376, // 202 bpm
     12315, // 203 bpm
     12255, // 204 bpm
     12195, // 205 bpm
     12136, // 206 bpm
     12077, // 207 bpm
     12019, // 208 bpm
     11962, // 209 bpm
     11905, // 210 bpm
     11848, // 211 bpm
     11792, // 212 bpm
     11737, // 213 bpm
     11682, // 214 bpm
     11628, // 215 bpm
     11574, // 216 bpm
     11521, // 217 bpm
     11468, // 218 bpm
     11416, // 219 bpm
     11364, // 220 bpm
     11312, // 221 bpm
     11261, // 222 bpm
     11211, // 223 bpm
     11161, // 224 bpm
     11111, // 225 bpm
     11062, // 226 bpm
     11013, // 227 bpm
     10965, // 228 bpm
     10917, // 229 bpm
     10870, // 230 bpm
     10823, // 231 bpm
     10776, // 232 bpm
     10730, // 233 bpm
     10684, // 234 bpm
     10638, // 235 bpm
     10593, // 236 bpm
     10549, // 237 bpm
     10504, // 238 bpm
     10460, // 239 bpm
     10417, // 240 bpm
     10373, // 241 bpm
     10331, // 242 bpm
     10288, // 243 bpm
     10246, // 244 bpm
     10204, // 245 bpm
     10163, // 246 bpm
     10121, // 247 bpm
     10081, // 248 bpm
     10040, // 249 bpm
     10000, // 250 bpm
     9960 , // 251 bpm
     9921 , // 252 bpm
     9881 , // 253 bpm
     9843 , // 254 bpm
     9804 , // 255 bpm
     9766 , // 256 bpm
     9728 , // 257 bpm
     9690 , // 258 bpm
     9653 , // 259 bpm
     9615 , // 260 bpm
     9579 , // 261 bpm
     9542 , // 262 bpm
     9506 , // 263 bpm
     9470 , // 264 bpm
     9434 , // 265 bpm
     9398 , // 266 bpm
     9363 , // 267 bpm
     9328 , // 268 bpm
     9294 , // 269 bpm
     9259 , // 270 bpm
     9225 , // 271 bpm
     9191 , // 272 bpm
     9158 , // 273 bpm
     9124 , // 274 bpm
     9091 , // 275 bpm
     9058 , // 276 bpm
     9025 , // 277 bpm
     8993 , // 278 bpm
     8961 , // 279 bpm
     8929 , // 280 bpm
     45455, // 55 bpm
     44643, // 56 bpm
     43860, // 57 bpm
     43103, // 58 bpm
     42373, // 59 bpm
     41667, // 60 bpm
     40984, // 61 bpm
     40323, // 62 bpm
     39683, // 63 bpm
     39063, // 64 bpm
     38462, // 65 bpm
     37879, // 66 bpm
     37313, // 67 bpm
     36765, // 68 bpm
     36232, // 69 bpm
     35714, // 70 bpm
     35211, // 71 bpm
     34722, // 72 bpm
     34247, // 73 bpm
     33784, // 74 bpm
     33333, // 75 bpm
     32895, // 76 bpm
     32468, // 77 bpm
     32051, // 78 bpm
     31646, // 79 bpm
     31250, // 80 bpm
     30864, // 81 bpm
     30488, // 82 bpm
     30120, // 83 bpm
     29762, // 84 bpm
     29412, // 85 bpm
     29070, // 86 bpm
     28736, // 87 bpm
     28409, // 88 bpm
     28090, // 89 bpm
     27778, // 90 bpm
     27473, // 91 bpm
     27174, // 92 bpm
     26882, // 93 bpm
     26596, // 94 bpm
     26316, // 95 bpm
     26042, // 96 bpm
     25773, // 97 bpm
     25510, // 98 bpm
     25253, // 99 bpm
     25000, // 100 bpm
     24752, // 101 bpm
     24510, // 102 bpm
     24272, // 103 bpm
     24038, // 104 bpm
     23810, // 105 bpm
     23585, // 106 bpm
     23364, // 107 bpm
     23148, // 108 bpm
     22936, // 109 bpm
     22727, // 110 bpm
     22523, // 111 bpm
     22321, // 112 bpm
     22124, // 113 bpm
     21930, // 114 bpm
     21739, // 115 bpm
     21552, // 116 bpm
     21368, // 117 bpm
     21186, // 118 bpm
     21008, // 119 bpm
     20833, // 120 bpm
     20661, // 121 bpm
     20492, // 122 bpm
     20325, // 123 bpm
     20161, // 124 bpm
     20000, // 125 bpm
     19841, // 126 bpm
     19685, // 127 bpm
     19531, // 128 bpm
     19380, // 129 bpm
     19231, // 130 bpm
     19084, // 131 bpm
     18939, // 132 bpm
     18797, // 133 bpm
     18657, // 134 bpm
     18519, // 135 bpm
     18382, // 136 bpm
     18248, // 137 bpm
     18116, // 138 bpm
     17986, // 139 bpm
     17857, // 140 bpm
     17730, // 141 bpm
     17606, // 142 bpm
     17483, // 143 bpm
     17361, // 144 bpm
     17241, // 145 bpm
     17123, // 146 bpm
     17007, // 147 bpm
     16892, // 148 bpm
     16779, // 149 bpm
     16667, // 150 bpm
     16556, // 151 bpm
     16447, // 152 bpm
     16340, // 153 bpm
     16234, // 154 bpm
     16129, // 155 bpm
     16026, // 156 bpm
     15924, // 157 bpm
     15823, // 158 bpm
     15723, // 159 bpm
     15625, // 160 bpm
     15528, // 161 bpm
     15432, // 162 bpm
     15337, // 163 bpm
     15244, // 164 bpm
     15152, // 165 bpm
     15060, // 166 bpm
     14970, // 167 bpm
     14881, // 168 bpm
     14793, // 169 bpm
     14706, // 170 bpm
     14620, // 171 bpm
     14535, // 172 bpm
     14451, // 173 bpm
     14368, // 174 bpm
     14286, // 175 bpm
     14205, // 176 bpm
     14124, // 177 bpm
     14045, // 178 bpm
     13966, // 179 bpm
     13889, // 180 bpm
     13812, // 181 bpm
     13736, // 182 bpm
     13661, // 183 bpm
     13587, // 184 bpm
     13514, // 185 bpm
     13441, // 186 bpm
     13369, // 187 bpm
     13298, // 188 bpm
     13228, // 189 bpm
     13158, // 190 bpm
     13089, // 191 bpm
     13021, // 192 bpm
     12953, // 193 bpm
     12887, // 194 bpm
     12821, // 195 bpm
     12755, // 196 bpm
     12690, // 197 bpm
     12626, // 198 bpm
     12563, // 199 bpm
     12500, // 200 bpm
     12438, // 201 bpm
     12376, // 202 bpm
     12315, // 203 bpm
     12255, // 204 bpm
     12195, // 205 bpm
     12136, // 206 bpm
     12077, // 207 bpm
     12019, // 208 bpm
     11962, // 209 bpm
     11905, // 210 bpm
     11848, // 211 bpm
     11792, // 212 bpm
     11737, // 213 bpm
     11682, // 214 bpm
     11628, // 215 bpm
     11574, // 216 bpm
     11521, // 217 bpm
     11468, // 218 bpm
     11416, // 219 bpm
     11364, // 220 bpm
     11312, // 221 bpm
     11261, // 222 bpm
     11211, // 223 bpm
     11161, // 224 bpm
     11111, // 225 bpm
     11062, // 226 bpm
     11013, // 227 bpm
     10965, // 228 bpm
     10917, // 229 bpm
     10870, // 230 bpm
     10823, // 231 bpm
     10776, // 232 bpm
     10730, // 233 bpm
     10684, // 234 bpm
     10638, // 235 bpm
     10593, // 236 bpm
     10549, // 237 bpm
     10504, // 238 bpm
     10460, // 239 bpm
     10417, // 240 bpm
     10373, // 241 bpm
     10331, // 242 bpm
     10288, // 243 bpm
     10246, // 244 bpm
     10204, // 245 bpm
     10163, // 246 bpm
     10121, // 247 bpm
     10081, // 248 bpm
     10040, // 249 bpm
     10000, // 250 bpm
     9960 , // 251 bpm
     9921 , // 252 bpm
     9881 , // 253 bpm
     9843 , // 254 bpm
     9804 , // 255 bpm
     9766 , // 256 bpm
     9728 , // 257 bpm
     9690 , // 258 bpm
     9653 , // 259 bpm
     9615 , // 260 bpm
     9579 , // 261 bpm
     9542 , // 262 bpm
     9506 , // 263 bpm
     9470 , // 264 bpm
     9434 , // 265 bpm
     9398 , // 266 bpm
     9363 , // 267 bpm
     9328 , // 268 bpm
     9294 , // 269 bpm
     9259 , // 270 bpm
     9225 , // 271 bpm
     9191 , // 272 bpm
     9158 , // 273 bpm
     9124 , // 274 bpm
     9091 , // 275 bpm
     9058 , // 276 bpm
     9025 , // 277 bpm
     8993 , // 278 bpm
     8961 , // 279 bpm
     8929 , // 280 bpm
};

/*******************/
/* Private methods */
/*******************/


/******************/
/* Public methods */
/******************/

YASS_TICKS::YASS_TICKS()
{
}

void YASS_TICKS::begin()
{
    stop();
}

void YASS_TICKS::setTempo(word bpm)
{
    if(bpm > YASS_TICKS_MAX_BPM)
        bpm = YASS_TICKS_MAX_BPM;
    if(bpm < YASS_TICKS_MIN_BPM)
        bpm = YASS_TICKS_MIN_BPM;
    tickDuration = pgm_read_word_near(YASS_TICKS_usec_durations + bpm - YASS_TICKS_MIN_BPM);
    tempo = bpm;
}

word YASS_TICKS::getTempo()
{
    return tempo;
}

bool YASS_TICKS::isRunning()
{
    return runningFlag;
}

void YASS_TICKS::start()
{
    runningFlag = true;
}

void YASS_TICKS::stop()
{
    runningFlag = false;
}

void YASS_TICKS::setCallback(void(*_callback)())
{
    callback = _callback;
}

void YASS_TICKS::sequencer()
{
    if(runningFlag)
    {
        if(micros() >= milestone)
        {
            if(callback)
                callback();
            milestone += tickDuration;
        }
    }
}

byte* YASS_TICKS::getDataPointer()
{
    return (byte*)(&tempo);
}
